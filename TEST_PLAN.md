# PolyMind 测试计划

## 概述

本文档描述 PolyMind 项目的全面测试策略、测试用例和测试执行计划。

## 测试目标

1. **功能完整性** - 验证所有功能模块按预期工作
2. **代码质量** - 确保代码逻辑正确，无明显Bug
3. **性能稳定性** - 验证系统在负载下的表现
4. **安全性** - 验证认证、授权和数据安全
5. **用户体验** - 验证前端交互的流畅性

## 测试范围

### 测试类型

| 类型 | 覆盖模块 | 优先级 |
|------|----------|--------|
| 单元测试 | Auth, Users, Rooms, Messages, AI | 高 |
| 集成测试 | API, Database, WebSocket | 高 |
| E2E测试 | 用户流程 | 中 |
| 性能测试 | API响应, 并发连接 | 低 |
| 安全测试 | JWT, 注入攻击 | 中 |

## 测试环境

### 开发环境
- Node.js 20
- PostgreSQL 15 (Docker)
- Redis 7 (Docker)

### 测试数据
- 测试用户: 10个
- 测试房间: 5个
- 测试消息: 100条
- 测试AI模型: 3个

## 测试用例

### 1. 认证模块 (Auth)

#### TC-AUTH-001: 用户注册成功
```gherkin
场景: 新用户成功注册
  假设 用户不存在
  当 用户提交有效的注册信息
  那么 系统创建新用户
  并且 返回JWT Token
```

#### TC-AUTH-002: 用户注册失败 - 邮箱已存在
```gherkin
场景: 使用已注册的邮箱注册
  假设 邮箱已注册
  当 用户使用该邮箱注册
  那么 系统返回错误 "邮箱已被注册"
```

#### TC-AUTH-003: 用户登录成功
```gherkin
场景: 用户使用正确凭证登录
  假设 用户已注册
  当 用户提交正确的邮箱和密码
  那么 系统返回JWT Token
```

#### TC-AUTH-004: 用户登录失败 - 密码错误
```gherkin
场景: 用户输入错误密码
  假设 用户已注册
  当 用户输入错误的密码
  那么 系统返回错误 "邮箱或密码错误"
```

#### TC-AUTH-005: Token验证
```gherkin
场景: 使用有效Token访问受保护资源
  假设 用户已登录并持有有效Token
  当 用户发送带有Token的请求
  那么 系统允许访问
```

### 2. 用户模块 (Users)

#### TC-USER-001: 获取用户信息
```gherkin
场景: 获取当前用户信息
  假设 用户已登录
  当 用户请求 /api/users/me
  那么 返回当前用户信息
```

#### TC-USER-002: 更新用户信息
```gherkin
场景: 更新用户头像
  假设 用户已登录
  当 用户提交新的头像URL
  那么 用户头像更新成功
```

### 3. 房间模块 (Rooms)

#### TC-ROOM-001: 创建房间
```gherkin
场景: 用户创建新房间
  假设 用户已登录
  当 用户创建房间 "AI讨论群"
  那么 房间创建成功
  并且 用户成为房间所有者
```

#### TC-ROOM-002: 获取房间列表
```gherkin
场景: 获取用户所属房间
  假设 用户是3个房间的成员
  当 用户请求房间列表
  那么 返回3个房间
```

#### TC-ROOM-003: 获取房间详情
```gherkin
场景: 获取房间详细信息
  假设 用户是房间成员
  当 用户获取房间详情
  那么 返回房间信息和成员列表
```

#### TC-ROOM-004: 添加AI成员
```gherkin
场景: 房间所有者添加AI成员
  假设 用户是房间所有者
  并且 有可用的AI模型
  当 用户添加AI到房间
  那么 AI成为房间成员
```

#### TC-ROOM-005: 离开房间
```gherkin
场景: 普通成员离开房间
  假设 用户是房间成员（非所有者）
  当 用户离开房间
  那么 用户不再属于该房间
```

#### TC-ROOM-006: 房主不能直接离开
```gherkin
场景: 房间所有者尝试直接离开
  假设 用户是房间所有者
  当 用户尝试离开房间
  那么 系统返回错误
```

### 4. 消息模块 (Messages)

#### TC-MSG-001: 发送消息
```gherkin
场景: 用户发送消息到房间
  假设 用户是房间成员
  当 用户发送消息 "Hello"
  那么 消息成功保存
  并且 广播给房间所有成员
```

#### TC-MSG-002: 获取消息历史
```gherkin
场景: 获取房间消息历史
  假设 房间有50条消息
  当 用户请求消息历史
  那么 返回最多50条消息
```

#### TC-MSG-003: 分页获取消息
```gherkin
场景: 分页获取消息
  假设 房间有100条消息
  当 用户请求第2页，每页20条
  那么 返回第21-40条消息
```

#### TC-MSG-004: 编辑消息
```gherkin
场景: 用户编辑自己1小时内的消息
  假设 用户在30分钟前发送了消息
  当 用户编辑消息内容
  那么 消息更新成功
  并且 广播编辑事件
```

#### TC-MSG-005: 编辑超时消息失败
```gherkin
场景: 用户编辑超过1小时的消息
  假设 用户在2小时前发送了消息
  当 用户尝试编辑消息
  那么 系统拒绝编辑
```

#### TC-MSG-006: 删除消息
```gherkin
场景: 用户删除自己发送的消息
  假设 用户发送了消息
  当 用户删除该消息
  那么 消息标记为已删除
```

#### TC-MSG-007: @提及用户
```gherkin
场景: 用户@提及其他成员
  假设 房间有用户A和B
  当 用户A发送 "@B 你好"
  那么 消息保存成功
  并且 B收到提及通知
```

### 5. AI聊天模块 (AI Chat)

#### TC-AI-001: AI响应用户消息
```gherkin
场景: AI响应用户消息
  假设 房间有AI成员
  当 用户发送消息
  那么 AI生成并发送响应
```

#### TC-AI-002: 多AI并行响应
```gherkin
场景: 多个AI同时响应
  假设 房间有GPT-4和Claude两个AI
  当 用户发送消息
  那么 两个AI都生成响应
```

#### TC-AI-003: AI流式输出
```gherkin
场景: AI响应使用流式输出
  假设 AI配置为流式输出
  当 AI生成响应
  那么 前端实时显示生成的内容
```

#### TC-AI-004: AI上下文管理
```gherkin
场景: AI保持对话上下文
  假设 用户与AI有多轮对话
  当 用户继续对话
  那么 AI能记住之前的对话内容
```

### 6. WebSocket模块

#### TC-WS-001: WebSocket连接
```gherkin
场景: 用户建立WebSocket连接
  假设 用户已登录
  当 用户连接到 /socket.io
  那么 连接建立成功
```

#### TC-WS-002: 加入房间
```gherkin
场景: 用户通过WebSocket加入房间
  假设 用户已连接WebSocket
  当 用户发送 room:join 事件
  那么 用户加入房间
  并且 收到房间消息
```

#### TC-WS-003: 接收实时消息
```gherkin
场景: 用户接收房间消息
  假设 用户在房间中
  当 其他用户发送消息
  那么 用户通过WebSocket收到消息
```

#### TC-WS-004: 成员加入通知
```gherkin
场景: 新成员加入通知
  假设 用户在房间中
  当 新成员加入房间
  那么 用户收到加入通知
```

#### TC-WS-005: 正在输入状态
```gherkin
场景: 用户正在输入通知
  假设 用户在房间中
  当 用户开始输入
  那么 房间其他用户看到输入状态
```

### 7. 安全测试

#### TC-SEC-001: 未授权访问
```gherkin
场景: 未登录用户访问受保护API
  假设 用户未登录
  当 用户发送请求
  那么 系统返回401错误
```

#### TC-SEC-002: 越权访问
```gherkin
场景: 用户访问不属于自己的房间
  假设 用户A不属于房间X
  当 用户A请求房间X的详情
  那么 系统返回403错误
```

#### TC-SEC-003: SQL注入防护
```gherkin
场景: 尝试SQL注入攻击
  假设 攻击者在输入中包含SQL
  当 系统处理输入
  那么 攻击被阻止
```

#### TC-SEC-004: XSS防护
```gherkin
场景: 尝试XSS攻击
  假设 攻击者发送包含恶意脚本的消息
  当 系统处理消息
  那么 脚本被转义或过滤
```

## 测试数据

### 用户数据
| 邮箱 | 用户名 | 密码 | 角色 |
|------|--------|------|------|
| test1@polymind.local | testuser1 | Test123!@# | 普通用户 |
| test2@polymind.local | testuser2 | Test123!@# | 普通用户 |
| admin@polymind.local | admin | Admin123!@# | 管理员 |

### AI模型数据
| 提供商 | 模型名称 | 显示名称 |
|--------|----------|----------|
| openai | gpt-3.5-turbo | GPT-3.5 |
| claude | claude-sonnet-4-20250514 | Claude |
| qwen | qwen-turbo | 通义千问 |

## 测试工具

### 后端测试
- Jest - 测试框架
- Supertest - HTTP测试
- faker - 测试数据生成

### 前端测试
- Jest - 单元测试
- React Testing Library - 组件测试
- Cypress - E2E测试

### 负载测试
- k6 - 性能测试

## 执行计划

### 第一阶段: 单元测试
- 测试所有Service层逻辑
- 覆盖率目标: 80%

### 第二阶段: 集成测试
- 测试API端点
- 测试数据库集成
- 测试WebSocket

### 第三阶段: E2E测试
- 测试完整用户流程
- 覆盖主要使用场景

## 验收标准

| 指标 | 目标值 |
|------|--------|
| 测试用例通过率 | 100% |
| 单元测试覆盖率 | 80% |
| 严重Bug数 | 0 |
| 阻塞Bug数 | 0 |
| 性能达标 | API响应 < 500ms |

## 风险和应对

| 风险 | 影响 | 应对措施 |
|------|------|----------|
| 外部API不稳定 | AI功能测试失败 | 使用Mock |
| 测试环境配置复杂 | 测试执行慢 | 优化Docker配置 |
| 异步测试不稳定 | 测试 flaky | 增加重试机制 |
