// Prisma Schema for PolyMind
// 数据库: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// 用户表
// ============================================
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  username      String    @unique
  passwordHash  String
  avatarUrl     String?
  status        UserStatus @default(active)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // 关联关系
  ownedRooms       ChatRoom[]           @relation("RoomOwner")
  memberships      RoomMember[]         @relation("UserMembership")
  sentMessages     Message[]            @relation("UserMessage")
  readRecords      MessageRead[]
  reactions        MessageReaction[]
  aiModels         AIModel[]            @relation("AIModelCreator")
  passwordResets   PasswordResetToken[] @relation("UserPasswordResets")
  uploadedFiles    File[]
  agentRoles       AgentRole[]
  kbVersions       KBVersion[]
  agentTeams       AgentTeam[]

  @@map("users")
}

// 用户状态枚举
enum UserStatus {
  active
  inactive
  banned
}

// ============================================
// AI模型配置表
// ============================================
model AIModel {
  id              String    @id @default(uuid())
  provider        String    // 'openai', 'claude', 'gemini', etc.
  modelName       String    // 'gpt-4', 'claude-3-opus', etc.
  displayName     String
  apiEndpoint     String?
  apiKeyEncrypted String?   // 加密存储
  systemPrompt    String?
  temperature     Float     @default(0.7)
  maxTokens       Int       @default(2048)
  isActive        Boolean   @default(true)
  createdById     String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // 关联关系
  createdBy       User?             @relation("AIModelCreator", fields: [createdById], references: [id])
  memberships     RoomMember[]      @relation("AIMembership")
  messages        Message[]         @relation("AIMessage")
  conversationContexts AiConversationContext[]

  @@map("ai_models")
}

// ============================================
// 群聊房间表
// ============================================
model ChatRoom {
  id          String      @id @default(uuid())
  name        String
  description String?
  createdById String
  maxMembers  Int         @default(50)
  isPrivate   Boolean     @default(false)
  status      RoomStatus  @default(active)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // 关联关系
  createdBy   User        @relation("RoomOwner", fields: [createdById], references: [id])
  members     RoomMember[]
  messages    Message[]
  contexts    AiConversationContext[]
  files       File[]
  agentTeams  AgentTeam[]

  @@map("chat_rooms")
}

// 房间状态枚举
enum RoomStatus {
  active
  archived
  deleted
}

// ============================================
// 房间成员表
// ============================================
model RoomMember {
  id          String      @id @default(uuid())
  roomId      String
  userId      String?
  aiModelId   String?
  memberType  MemberType
  role        MemberRole  @default(member)
  aiPrompt    String?
  joinedAt    DateTime    @default(now())

  // 关联关系
  room        ChatRoom    @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user        User?       @relation("UserMembership", fields: [userId], references: [id], onDelete: Cascade)
  aiModel     AIModel?    @relation("AIMembership", fields: [aiModelId], references: [id], onDelete: Cascade)

  @@unique([roomId, userId])
  @@unique([roomId, aiModelId])
  @@map("room_members")
}

// 成员类型枚举
enum MemberType {
  human
  ai
}

// 成员角色枚举
enum MemberRole {
  owner
  admin
  member
}

// ============================================
// 消息表
// ============================================
model Message {
  id              String        @id @default(uuid())
  roomId          String
  senderType      MemberType
  senderUserId    String?
  senderAiModelId String?
  content         String
  contentType     MessageContentType @default(text)
  replyToId       String?
  mentions        String[]      // 被提及的用户/AI ID数组
  metadata        Json?         // 额外信息（如AI的token使用量）
  isDeleted       Boolean       @default(false)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // 关联关系
  room            ChatRoom      @relation(fields: [roomId], references: [id], onDelete: Cascade)
  senderUser      User?         @relation("UserMessage", fields: [senderUserId], references: [id], onDelete: Cascade)
  senderAiModel   AIModel?      @relation("AIMessage", fields: [senderAiModelId], references: [id], onDelete: Cascade)
  replyTo         Message?      @relation("MessageReply", fields: [replyToId], references: [id], onDelete: SetNull)
  replies         Message[]     @relation("MessageReply")
  readRecords     MessageRead[]
  reactions       MessageReaction[]

  @@index([roomId, createdAt])
  @@map("messages")
}

// 消息内容类型枚举
enum MessageContentType {
  text
  image
  file
}

// ============================================
// 消息已读状态表
// ============================================
model MessageRead {
  id        String   @id @default(uuid())
  messageId String
  userId    String
  readAt    DateTime @default(now())

  // 关联关系
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@map("message_reads")
}

// ============================================
// 消息反应表
// ============================================
model MessageReaction {
  id        String   @id @default(uuid())
  messageId String
  userId    String
  emoji     String
  createdAt DateTime @default(now())

  // 关联关系
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId, emoji])
  @@map("message_reactions")
}

// ============================================
// AI对话上下文表
// ============================================
model AiConversationContext {
  id              String    @id @default(uuid())
  roomId          String
  aiModelId       String
  contextMessages Json      // 存储最近的对话历史
  summary         String?   // 对话摘要
  tokenCount      Int       @default(0)
  updatedAt       DateTime  @updatedAt

  // 关联关系
  room            ChatRoom  @relation(fields: [roomId], references: [id], onDelete: Cascade)
  aiModel         AIModel   @relation(fields: [aiModelId], references: [id], onDelete: Cascade)

  @@unique([roomId, aiModelId])
  @@map("ai_conversation_contexts")
}

// ============================================
// 密码重置令牌表
// ============================================
model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  // 关联关系
  user User @relation("UserPasswordResets", fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("password_reset_tokens")
}

// ============================================
// 文件表
// ============================================
model File {
  id          String    @id @default(uuid())
  filename    String    // 原始文件名
  mimeType    String    // MIME类型
  size        Int       // 文件大小（字节）
  url         String    // 文件访问URL
  storageType StorageType @default(local) // 存储类型
  uploaderId  String    // 上传者ID
  roomId      String?   // 关联的房间ID（可选）
  messageId   String?   // 关联的消息ID（可选）
  metadata    Json?     // 额外元数据（如图片尺寸、PDF页数等）
  createdAt   DateTime  @default(now())

  // 关联关系
  uploader    User      @relation(fields: [uploaderId], references: [id], onDelete: Cascade)
  room        ChatRoom? @relation(fields: [roomId], references: [id], onDelete: SetNull)

  @@index([roomId])
  @@index([uploaderId])
  @@map("files")
}

// 存储类型枚举
enum StorageType {
  local       // 本地存储
  s3          // AWS S3
  oss         // 阿里云OSS
  cos         // 腾讯云COS
}

// ============================================
// Agent角色表
// ============================================
model AgentRole {
  id          String    @id @default(uuid())
  name        String
  description String?
  systemPrompt String   @db.Text
  avatarUrl   String?
  isTemplate  Boolean   @default(false)
  createdById String?
  tags        String[]  @default([])
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // 关联关系
  createdBy   User?     @relation(fields: [createdById], references: [id], onDelete: SetNull)
  teamAgents  AgentTeamAgent[]

  @@index([isTemplate])
  @@map("agent_roles")
}

// ============================================
// Agent团队表
// ============================================
model AgentTeam {
  id          String    @id @default(uuid())
  name        String
  description String?
  mode        String    // 'parallel' | 'sequential' | 'debate'
  roomId      String
  createdById String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // 关联关系
  room        ChatRoom  @relation(fields: [roomId], references: [id], onDelete: Cascade)
  createdBy   User      @relation(fields: [createdById], references: [id], onDelete: Cascade)
  agents      AgentTeamAgent[]

  @@index([roomId])
  @@map("agent_teams")
}

// ============================================
// Agent团队成员关联表
// ============================================
model AgentTeamAgent {
  id        String    @id @default(uuid())
  teamId    String
  roleId    String
  order     Int       @default(0)
  condition String?   // 执行条件（用于条件分支）

  // 关联关系
  team      AgentTeam @relation(fields: [teamId], references: [id], onDelete: Cascade)
  role      AgentRole @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([teamId, roleId])
  @@map("agent_team_agents")
}

// ============================================
// 知识库版本表
// ============================================
model KBVersion {
  id            String    @id @default(uuid())
  documentId    String
  versionNumber Int
  title         String
  description   String?
  changeSummary String?
  status        VersionStatus @default(draft)
  tags          String[]  @default([])
  isAutoSave    Boolean   @default(false)
  createdById   String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // 关联关系
  createdBy  User?              @relation(fields: [createdById], references: [id], onDelete: SetNull)
  contents   KBVersionContent[]

  @@unique([documentId, versionNumber])
  @@index([documentId])
  @@index([createdAt])
  @@map("kb_versions")
}

// 知识库版本状态枚举
enum VersionStatus {
  draft
  published
  archived
}

// ============================================
// 知识库版本内容表
// ============================================
model KBVersionContent {
  id          String    @id @default(uuid())
  versionId   String
  blockType   String
  content     Json
  order       Int       @default(0)
  createdAt   DateTime  @default(now())

  // 关联关系
  version   KBVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)

  @@index([versionId])
  @@index([versionId, order])
  @@map("kb_version_contents")
}

// ============================================
// 角色扮演场景表
// ============================================
model RoleScenario {
  id            String    @id @default(uuid())
  name          String
  role          String
  description   String
  systemPrompt  String    @db.Text
  difficulty    String    @default("intermediate")
  category      String    @default("custom")
  userId        String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([category])
  @@index([difficulty])
  @@map("role_scenarios")
}

// ============================================
// 会议表
// ============================================
model Meeting {
  id          String    @id @default(uuid())
  title       String
  description String?
  roomId      String?
  status      String    @default("scheduled")
  startedAt   DateTime?
  endedAt     DateTime?
  createdAt   DateTime  @default(now())

  transcripts   MeetingTranscript[]
  summaries     MeetingSummary[]
  actionItems   MeetingActionItem[]

  @@index([status])
  @@index([createdAt])
  @@map("meetings")
}

// ============================================
// 会议转写表
// ============================================
model MeetingTranscript {
  id          String    @id @default(uuid())
  meetingId   String
  timestamp   Float
  speaker     String
  content     String    @db.Text
  confidence  Float     @default(1.0)
  isEdited    Boolean   @default(false)
  createdAt   DateTime  @default(now())

  meeting Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  @@index([meetingId])
  @@index([timestamp])
  @@map("meeting_transcripts")
}

// ============================================
// 会议摘要表
// ============================================
model MeetingSummary {
  id          String    @id @default(uuid())
  meetingId   String
  type        String    // 'executive', 'detailed', 'action_items'
  content     String    @db.Text
  generatedAt DateTime  @default(now())

  meeting Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  @@index([meetingId])
  @@index([type])
  @@map("meeting_summaries")
}

// ============================================
// 会议行动项表
// ============================================
model MeetingActionItem {
  id          String    @id @default(uuid())
  meetingId   String
  description String    @db.Text
  assignee    String?
  dueDate     DateTime?
  priority    String    @default("medium")
  status      String    @default("pending")
  createdAt   DateTime  @default(now())

  meeting Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  @@index([meetingId])
  @@index([priority])
  @@index([status])
  @@map("meeting_action_items")
}

// ============================================
// 思维导图表
// ============================================
model MindMap {
  id          String    @id @default(uuid())
  title       String
  layout      String    @default("mindmap")
  mermaidCode String    @db.Text
  depth       Int       @default(3)
  createdAt   DateTime  @default(now())

  @@index([createdAt])
  @@map("mind_maps")
}
